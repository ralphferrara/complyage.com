package main

import (
	"api/db"
	"api/geo"
	"api/handlers"
	"api/keys"
	"api/models"
	"fmt"
	"log"
	"net/http"
	"os"
	"time"

	"github.com/gorilla/mux"
	"github.com/joho/godotenv"
)

//||------------------------------------------------------------------------------------------------||
//|| Use DB vs In-Memory
//||------------------------------------------------------------------------------------------------||

var UseInMemory bool

//||------------------------------------------------------------------------------------------------||
//|| Main
//||------------------------------------------------------------------------------------------------||

func main() {
	//||------------------------------------------------------------------------------------------------||
	//|| Load Env
	//||------------------------------------------------------------------------------------------------||
	err := godotenv.Load()
	if err != nil {
		fmt.Println("No .env file found, continuing...")
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Should we use in-memory storage or DB?
	//||------------------------------------------------------------------------------------------------||
	env := os.Getenv("ENV_MODE")
	fmt.Println("ENV_MODE = " + env)
	if env == "production" {
		fmt.Println("Running in production mode, using In memory storage")
		UseInMemory = true
	} else {
		fmt.Println("Running in development mode, using DB")
		UseInMemory = false
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Open DB Connection
	//||------------------------------------------------------------------------------------------------||
	db.Connect()
	//||------------------------------------------------------------------------------------------------||
	//|| GORM
	//||------------------------------------------------------------------------------------------------||
	db.DB.AutoMigrate(&models.User{})
	//||------------------------------------------------------------------------------------------------||
	//|| Open DB Connection
	//||------------------------------------------------------------------------------------------------||
	if UseInMemory {
		fmt.Println("Loading IP ranges...Please be patient, takes minutes")
		if err := geo.LoadIPRanges(); err != nil {
			panic(fmt.Sprintf("Failed to load IP ranges: %v", err))
		}
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Auto Reload API Keys
	//||------------------------------------------------------------------------------------------------||
	if UseInMemory {
		keys.StartAutoReload(5 * time.Minute)
	}
	//||------------------------------------------------------------------------------------------------||
	//|| Setup Router
	//||------------------------------------------------------------------------------------------------||
	router := mux.NewRouter()
	//||------------------------------------------------------------------------------------------------||
	//|| Middleware
	//||------------------------------------------------------------------------------------------------||
	router.Use(LoggerMiddleware)
	//||------------------------------------------------------------------------------------------------||
	//|| API Routes
	//||------------------------------------------------------------------------------------------------||
	router.HandleFunc("/v1/api/lookup", handlers.LookupRequirements).Methods("GET")
	//||------------------------------------------------------------------------------------------------||
	//|| Publc Routes
	//||------------------------------------------------------------------------------------------------||
	router.HandleFunc("/auth/login", handlers.LoginHandler).Methods("POST")
	router.HandleFunc("/auth/signup", handlers.SignupHandler).Methods("POST")
	router.HandleFunc("/auth/me", handlers.AuthMeHandler).Methods("GET")
	//||------------------------------------------------------------------------------------------------||
	//|| Logger Middleware
	//||------------------------------------------------------------------------------------------------||
	router.NotFoundHandler = http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		fmt.Printf("[%s] %s %s => 404\n", time.Now().Format(time.RFC3339), r.Method, r.URL.Path)
		http.Error(w, "404 page not found", http.StatusNotFound)
	})
	//||------------------------------------------------------------------------------------------------||
	//|| We are up and running
	//||------------------------------------------------------------------------------------------------||
	fmt.Println("API server running on :8888")
	log.Fatal(http.ListenAndServe(":8888", router))
}

//||------------------------------------------------------------------------------------------------||
//|| Logger Middleware
//||------------------------------------------------------------------------------------------------||

func LoggerMiddleware(next http.Handler) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		fmt.Printf("[%s] %s %s\n", time.Now().Format(time.RFC3339), r.Method, r.URL.Path)
		next.ServeHTTP(w, r)
	})
}
